---
import Layout from "@layouts/Layout.astro";
import Header from "@components/Header.astro";
import Footer from "@components/Footer.astro";
import Breadcrumbs from "@components/Breadcrumbs.astro";

const artwork = [
  { title: "Flume - The Difference", video: "/assets/artwork/Flume-The-Difference.mp4", comment: "2020 - Made with SideFX Houdini" },
  { title: "Flume - Heater", video: "/assets/artwork/Flume-Heater.mp4", comment: "2021 - Made with SideFX Houdini" },
  { title: "Flume - DHLC", video: "/assets/artwork/Flume-DHLC.mp4", comment: "2021 - Made with SideFX Houdini" },
  { title: "Getter - Bad Acid", video: "/assets/artwork/Getter-Bad-Acid.mp4", comment: "2021 - Made with SideFX Houdini" },
];

const experiments = [
  { title: "Flume - 3 Eras Teaser", video: "/assets/artwork/Flume-3-Eras-Teaser.mp4" },
  { title: "Flume - Chalk", video: "/assets/artwork/Flume-Chalk-test.mp4" },
  { title: "Flume - I Can't Tell", video: "/assets/artwork/Flume-I-Cant-Tell.mp4" },
];
---

<Layout title="Artwork - Resources">
  <Header activeNav="art" />
  <Breadcrumbs />

  <main id="main-content">
    <section class="py-12 px-4">
      <div class="mx-auto max-w-4xl">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-8">
          {artwork.map((item, index) => (
            <article class="flex flex-col items-center text-center">
              <!-- Fixed height title container -->
              <div class="h-20 mb-4 flex items-center justify-center w-full">
                <h3 class="text-lg font-medium text-skin-base leading-tight line-clamp-3 px-2">
                  {item.title}
                </h3>
              </div>

              <!-- Video container -->
              <div class="mb-4 relative w-full">
                <video
                  src={item.video}
                  class="w-full border border-skin-border artwork-video"
                  controls
                  loop
                  muted
                  playsinline
                  preload={index < 4 ? "auto" : "metadata"}
                >
                  Your browser does not support the video tag.
                </video>
              </div>

              {item.comment && (
                <p class="text-sm text-skin-base leading-relaxed max-w-64">
                  {item.comment}
                </p>
              )}
            </article>
          ))}
        </div>

        <!-- Experiments Section -->
        <details class="mt-12">
          <summary class="cursor-pointer text-lg font-medium text-skin-base hover:text-skin-accent">
            Experiments
          </summary>
          <p class="mt-4 text-sm text-skin-base/70">
            A collection of smaller explorations and tests. Hope these spark some ideas.
          </p>
          <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-8">
            {experiments.map((item) => (
              <article class="flex flex-col items-center text-center">
                <div class="h-20 mb-4 flex items-center justify-center w-full">
                  <h3 class="text-lg font-medium text-skin-base leading-tight px-2">{item.title}</h3>
                </div>
                <div class="mb-4 relative w-full">
                  <video src={item.video} class="w-full border border-skin-border artwork-video" controls loop muted playsinline preload="metadata"></video>
                </div>
              </article>
            ))}
          </div>
        </details>
      </div>
    </section>
  </main>
  <Footer />
</Layout>

<style>
  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .artwork-video {
    background-color: #000;
    max-width: 100%;
    height: auto;
  }

  article {
    min-height: 350px;
  }
</style>

<script>
  function initVideos() {
    const videos = document.querySelectorAll('.artwork-video');

    // Force reload video sources after View Transitions
    videos.forEach(video => {
      video.load();
    });

    // Intersection Observer for lazy video loading
    const videoObserver = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        const video = entry.target;
        if (entry.isIntersecting) {
          video.play().catch(() => {});
        } else {
          video.pause();
        }
      });
    }, {
      rootMargin: '50px',
      threshold: 0.1
    });

    videos.forEach(video => {
      videoObserver.observe(video);
    });
  }

  // Handle both initial page load and Astro View Transitions
  document.addEventListener('astro:page-load', initVideos);
</script>
